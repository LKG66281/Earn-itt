<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Real-Time Tic Tac Toe</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f0f0f;
      color: white;
      text-align: center;
      padding: 20px;
    }
    .container {
      max-width: 400px;
      margin: auto;
      background: #1c1c1c;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #00ffcc;
    }
    input, button {
      padding: 10px;
      margin: 10px 0;
      width: 90%;
      border: none;
      border-radius: 5px;
    }
    button {
      background-color: #00ffcc;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      gap: 5px;
      justify-content: center;
      margin-top: 20px;
    }
    .cell {
      width: 80px;
      height: 80px;
      background: #333;
      font-size: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 5px;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    .glow-box {
      padding: 10px;
      margin-top: 10px;
      background: #222;
      border: 1px solid #00ffcc;
      color: #00ffcc;
      border-radius: 5px;
      box-shadow: 0 0 10px #00ffcc;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container" id="auth-section">
  <h2>Login / Signup</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <input type="text" id="username" placeholder="Username">
  <button id="signup-btn">Signup</button>
  <button id="login-btn">Login</button>
</div>

<div class="container hidden" id="waiting-section">
  <h2>Welcome, <span id="display-username"></span></h2>
  <p>Click below to find a match</p>
  <button id="find-match-btn">Play</button>
  <button id="logout-btn">Logout</button>
</div>

<div class="container hidden" id="game-section">
  <h3>You (<span id="player-symbol"></span>) vs <span id="opponent-name">Opponent</span></h3>
  <div class="board" id="board"></div>
  <p id="status-text">Waiting...</p>
  <div id="stats"></div>
</div>

<div class="glow-box hidden" id="message-box">Message</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, getDoc, updateDoc,
    onSnapshot, deleteDoc, collection, addDoc, query, where, getDocs, increment
  } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDs2taPm-p2O-dYdBToYwq7vZBUSDNISyg",
    authDomain: "earn-itt.firebaseapp.com",
    projectId: "earn-itt",
    storageBucket: "earn-itt.appspot.com",
    messagingSenderId: "785360520679",
    appId: "1:785360520679:web:ac2e2710ece34591a52942"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser, playerSymbol, currentRoomId;
  let gameOver = false;

  const authSection = document.getElementById("auth-section");
  const waitingSection = document.getElementById("waiting-section");
  const gameSection = document.getElementById("game-section");
  const boardDiv = document.getElementById("board");
  const statusText = document.getElementById("status-text");
  const messageBox = document.getElementById("message-box");

  function showMessage(msg) {
    messageBox.textContent = msg;
    messageBox.classList.remove("hidden");
    setTimeout(() => messageBox.classList.add("hidden"), 3000);
  }

  const statsDiv = document.getElementById("stats");

  function updateStatsDisplay(data) {
    statsDiv.textContent = `Games: ${data.gamesPlayed || 0}, Wins: ${data.wins || 0}, Losses: ${data.losses || 0}, Ties: ${data.ties || 0}`;
  }

  async function ensureUserStats(uid) {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, { gamesPlayed: 0, wins: 0, losses: 0, ties: 0 });
    }
    const userData = await getDoc(ref);
    updateStatsDisplay(userData.data());
  }

  async function updateStats(result) {
    const ref = doc(db, "users", currentUser.uid);
    const updates = { gamesPlayed: increment(1) };
    if (result === "win") updates.wins = increment(1);
    else if (result === "loss") updates.losses = increment(1);
    else if (result === "tie") updates.ties = increment(1);
    await updateDoc(ref, updates);
    const data = await getDoc(ref);
    updateStatsDisplay(data.data());
  }

  document.getElementById("signup-btn").onclick = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await ensureUserStats(cred.user.uid);
      showMessage("Signup successful!");
    } catch (e) {
      showMessage("Signup error: " + e.message);
    }
  };

  document.getElementById("login-btn").onclick = async () => {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      await ensureUserStats(cred.user.uid);
      showMessage("Login successful!");
    } catch (e) {
      showMessage("Login error: " + e.message);
    }
  };

  document.getElementById("logout-btn").onclick = async () => {
    await signOut(auth);
    location.reload();
  };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      authSection.classList.add("hidden");
      waitingSection.classList.remove("hidden");
      document.getElementById("display-username").textContent = document.getElementById("username").value || "Player";
      await ensureUserStats(user.uid);
    }
  });

  document.getElementById("find-match-btn").onclick = async () => {
    const waitingRef = collection(db, "waiting");
    const q = query(waitingRef);
    const snapshot = await getDocs(q);

    if (!snapshot.empty) {
      const docToJoin = snapshot.docs[0];
      const playerX = docToJoin.data();
      await deleteDoc(doc(db, "waiting", docToJoin.id));

      const roomRef = await addDoc(collection(db, "rooms"), {
        playerX,
        playerO: {
          uid: currentUser.uid,
          username: document.getElementById("username").value || "Player"
        },
        board: Array(9).fill(""),
        turn: "X",
        winner: ""
      });

      startGame(roomRef.id, "O");
    } else {
      await addDoc(waitingRef, {
        uid: currentUser.uid,
        username: document.getElementById("username").value || "Player"
      });
      showMessage("Waiting for another player...");
    }
  };

  function checkWinner(b) {
    const w = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    for (let [a,b1,c] of w) {
      if (b[a] && b[a] === b[b1] && b[a] === b[c]) return b[a];
    }
    return b.includes("") ? null : "tie";
  }

  function startGame(roomId, symbol) {
    playerSymbol = symbol;
    currentRoomId = roomId;
    gameOver = false;
    waitingSection.classList.add("hidden");
    gameSection.classList.remove("hidden");
    document.getElementById("player-symbol").textContent = symbol;

    const roomRef = doc(db, "rooms", roomId);
    onSnapshot(roomRef, async snap => {
      const d = snap.data();
      const board = d.board;
      const turn = d.turn;
      const winner = d.winner;

      const opponent = playerSymbol === "X" ? d.playerO : d.playerX;
      document.getElementById("opponent-name").textContent = opponent?.username || "Waiting...";

      boardDiv.innerHTML = "";
      board.forEach((val, i) => {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.textContent = val;
        if (val === "" && turn === playerSymbol && !winner) {
          cell.onclick = async () => {
            const freshSnap = await getDoc(roomRef);
            const freshBoard = freshSnap.data().board;
            if (freshBoard[i] === "") {
              const newBoard = [...freshBoard];
              newBoard[i] = playerSymbol;
              const result = checkWinner(newBoard);
              const updates = {
                board: newBoard,
                turn: playerSymbol === "X" ? "O" : "X"
              };
              if (result) updates.winner = result;
              await updateDoc(roomRef, updates);
            }
          };
        }
        boardDiv.appendChild(cell);
      });

      if (winner && !gameOver) {
        gameOver = true;
        if (winner === "tie") {
          showMessage("ü§ù It's a Tie!");
          statusText.textContent = "ü§ù It's a Tie!";
          updateStats("tie");
        } else if (winner === playerSymbol) {
          showMessage("üéâ You Win!");
          statusText.textContent = "üéâ You Win!";
          updateStats("win");
        } else {
          showMessage("üòì You Lose!");
          statusText.textContent = "üòì You Lose!";
          updateStats("loss");
        }
      } else if (!winner) {
        statusText.textContent = turn === playerSymbol ? "Your Turn" : "Opponent's Turn";
      }
    });
  }
</script>

</body>
</html>
