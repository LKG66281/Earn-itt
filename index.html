<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tic-Tac-Toe Multiplayer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f0f0f;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    .container {
      max-width: 400px;
      margin: auto;
      background: #1c1c1c;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #00ffcc;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      margin: 10px 0;
      width: 90%;
      border: none;
      border-radius: 5px;
      background: #2c2c2c;
      color: white;
    }
    button {
      background-color: #00ffcc;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    .hidden { display: none; }
    .glow-box {
      padding: 10px;
      margin: 10px auto;
      width: 90%;
      background: #222;
      border: 1px solid #00ffcc;
      color: #00ffcc;
      border-radius: 5px;
      box-shadow: 0 0 10px #00ffcc;
      font-weight: bold;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      gap: 5px;
      justify-content: center;
      margin-top: 20px;
    }
    .cell {
      width: 80px;
      height: 80px;
      background: #333;
      font-size: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border-radius: 5px;
    }
    #waiting-screen {
      background: #111;
      padding: 40px;
      color: #00ffcc;
      font-size: 18px;
      border: 2px dashed #00ffcc;
      border-radius: 10px;
      box-shadow: 0 0 20px #00ffcc;
    }
  </style>
</head>
<body>

<!-- AUTH -->
<div class="container" id="auth-section">
  <h2 id="auth-title">Login</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Password">
  <button id="auth-button">Login</button>
  <p><a href="#" id="toggle-auth">Don't have an account? Sign up</a></p>
</div>

<!-- DASHBOARD -->
<div class="container hidden" id="dashboard-section">
  <h2>Welcome</h2>
  <input type="text" id="username" placeholder="Update Username">
  <button id="update-username">Save Username</button>
  <p id="username-display">Username: </p>
  <p id="stats">Games: 0, Wins: 0, Losses: 0, Ties: 0</p>
  <button id="play-button">Play</button>
  <button id="logout">Logout</button>
</div>

<!-- MATCH OPTIONS -->
<div class="container hidden" id="play-options">
  <button id="random-match">Random Match</button>
  <button id="friend-match">Play with Friend</button>
</div>

<!-- FRIEND MATCH -->
<div class="container hidden" id="friend-options">
  <button id="create-room">Create Room</button>
  <input type="text" id="room-id-input" placeholder="Enter Room ID">
  <button id="join-room">Join Room</button>
</div>

<!-- WAITING -->
<div class="container hidden" id="waiting-screen">
  <p>‚è≥ Waiting for an opponent...</p>
</div>

<!-- GAME SECTION -->
<div class="container hidden" id="game-section">
  <h3>You (<span id="player-symbol"></span>) vs <span id="opponent-name">Opponent</span></h3>
  <p>Room ID: <span id="room-id-display"></span></p>
  <div class="board" id="game-board"></div>
  <p id="game-status">Waiting...</p>
</div>

<!-- MESSAGE BOX -->
<div class="glow-box hidden" id="message-box">Message</div>

<!-- FIREBASE + LOGIC -->
<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

  // Your Firebase config üî• (update this to your project!)
  const firebaseConfig = {
    apiKey: "AIzaSyDs2taPm-p2O-dYdBToYwq7vZBUSDNISyg",
    authDomain: "earn-itt.firebaseapp.com",
    projectId: "earn-itt",
    storageBucket: "earn-itt.appspot.com",
    messagingSenderId: "785360520679",
    appId: "1:785360520679:web:ac2e2710ece34591a52942"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- CONTINUED LOGIC WILL GO HERE ---
  // You already have the full Firebase real-time game logic built.
  // Since it's long, tell me:
  // üëâ ‚ÄúContinue with the full JavaScript logic here.‚Äù
// === DOM ELEMENTS ===
const authSection = document.getElementById("auth-section");
const dashboard = document.getElementById("dashboard-section");
const authBtn = document.getElementById("auth-button");
const toggleAuth = document.getElementById("toggle-auth");
const authTitle = document.getElementById("auth-title");
const email = document.getElementById("email");
const password = document.getElementById("password");
const usernameInput = document.getElementById("username");
const updateUsernameBtn = document.getElementById("update-username");
const usernameDisplay = document.getElementById("username-display");
const stats = document.getElementById("stats");
const logoutBtn = document.getElementById("logout");
const playBtn = document.getElementById("play-button");
const playOptions = document.getElementById("play-options");
const randomMatch = document.getElementById("random-match");
const friendMatch = document.getElementById("friend-match");
const friendOptions = document.getElementById("friend-options");
const createRoomBtn = document.getElementById("create-room");
const joinRoomBtn = document.getElementById("join-room");
const roomInput = document.getElementById("room-id-input");
const gameBoard = document.getElementById("game-board");
const gameSection = document.getElementById("game-section");
const gameStatus = document.getElementById("game-status");
const playerSymbol = document.getElementById("player-symbol");
const opponentName = document.getElementById("opponent-name");
const roomIdDisplay = document.getElementById("room-id-display");
const waitingScreen = document.getElementById("waiting-screen");
const msgBox = document.getElementById("message-box");

// === GLOBALS ===
let currentUser = null;
let roomId = null;
let player = null;
let gameUnsub = null;

// === HELPERS ===
function show(el) { el.classList.remove("hidden"); }
function hide(el) { el.classList.add("hidden"); }
function notify(msg) {
  msgBox.textContent = msg;
  show(msgBox);
  setTimeout(() => hide(msgBox), 3000);
}

// === AUTH ===
toggleAuth.onclick = () => {
  if (authTitle.textContent === "Login") {
    authTitle.textContent = "Sign Up";
    authBtn.textContent = "Sign Up";
    toggleAuth.textContent = "Already have an account? Login";
  } else {
    authTitle.textContent = "Login";
    authBtn.textContent = "Login";
    toggleAuth.textContent = "Don't have an account? Sign up";
  }
};

authBtn.onclick = async () => {
  const mail = email.value;
  const pass = password.value;
  if (authBtn.textContent === "Login") {
    await signInWithEmailAndPassword(auth, mail, pass).catch(e => alert(e.message));
  } else {
    await createUserWithEmailAndPassword(auth, mail, pass).catch(e => alert(e.message));
    await setDoc(doc(db, "users", auth.currentUser.uid), {
      username: "Player",
      wins: 0, losses: 0, ties: 0, games: 0
    });
  }
};

logoutBtn.onclick = () => signOut(auth);

// === USER STATE ===
onAuthStateChanged(auth, async user => {
  if (user) {
    currentUser = user;
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const data = userSnap.data();
      usernameInput.value = data.username;
      usernameDisplay.textContent = `Username: ${data.username}`;
      stats.textContent = `Games: ${data.games || 0}, Wins: ${data.wins || 0}, Losses: ${data.losses || 0}, Ties: ${data.ties || 0}`;
    }
    hide(authSection); show(dashboard);
  } else {
    currentUser = null;
    show(authSection); hide(dashboard);
  }
});

updateUsernameBtn.onclick = async () => {
  await updateDoc(doc(db, "users", currentUser.uid), {
    username: usernameInput.value
  });
  usernameDisplay.textContent = `Username: ${usernameInput.value}`;
  notify("Username updated");
};

// === MATCHMAKING ===
playBtn.onclick = () => {
  hide(dashboard); show(playOptions);
};
randomMatch.onclick = async () => {
  hide(playOptions); show(waitingScreen);
  const q = query(collection(db, "waiting"), where("uid", "!=", currentUser.uid));
  const qSnap = await getDocs(q);
  if (!qSnap.empty) {
    const docSnap = qSnap.docs[0];
    const { uid } = docSnap.data();
    const roomDoc = await addDoc(collection(db, "rooms"), {
      p1: uid,
      p2: currentUser.uid,
      board: Array(9).fill(""),
      turn: "X",
      winner: ""
    });
    roomId = roomDoc.id;
    await deleteDoc(doc(db, "waiting", docSnap.id));
    startGame("O", uid);
  } else {
    const waitRef = await addDoc(collection(db, "waiting"), { uid: currentUser.uid });
    const unsub = onSnapshot(collection(db, "rooms"), snap => {
      snap.docChanges().forEach(change => {
        if (change.type === "added") {
          const d = change.doc.data();
          if (d.p1 === currentUser.uid || d.p2 === currentUser.uid) {
            roomId = change.doc.id;
            unsub();
            deleteDoc(doc(db, "waiting", waitRef.id));
            startGame(d.p1 === currentUser.uid ? "X" : "O", d.p1 === currentUser.uid ? d.p2 : d.p1);
          }
        }
      });
    });
  }
};

friendMatch.onclick = () => {
  hide(playOptions); show(friendOptions);
};

createRoomBtn.onclick = async () => {
  const roomDoc = await addDoc(collection(db, "rooms"), {
    p1: currentUser.uid,
    p2: "",
    board: Array(9).fill(""),
    turn: "X",
    winner: ""
  });
  roomId = roomDoc.id;
  show(waitingScreen);
  const unsub = onSnapshot(doc(db, "rooms", roomId), snap => {
    const d = snap.data();
    if (d.p2 && d.p2 !== "") {
      unsub();
      startGame("X", d.p2);
    }
  });
};

joinRoomBtn.onclick = async () => {
  const id = roomInput.value;
  const ref = doc(db, "rooms", id);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const d = snap.data();
    if (!d.p2) {
      await updateDoc(ref, { p2: currentUser.uid });
      roomId = id;
      startGame("O", d.p1);
    } else alert("Room already full.");
  } else alert("Room not found.");
};

// === GAME START ===
async function startGame(symbol, opponentUid) {
  hide(waitingScreen); hide(friendOptions); hide(playOptions); show(gameSection);
  player = symbol;
  playerSymbol.textContent = player;
  roomIdDisplay.textContent = roomId;
  const oppSnap = await getDoc(doc(db, "users", opponentUid));
  opponentName.textContent = oppSnap.exists() ? oppSnap.data().username : "Opponent";
  renderBoard(Array(9).fill(""));
  gameUnsub = onSnapshot(doc(db, "rooms", roomId), snap => {
    const d = snap.data();
    renderBoard(d.board);
    if (d.winner && d.winner !== "") {
      gameStatus.textContent = d.winner === "Tie" ? "It's a Tie!" : (d.winner === player ? "You Win!" : "You Lose!");
      updateStats(d.winner);
      setTimeout(() => {
        gameUnsub();
        deleteDoc(doc(db, "rooms", roomId));
        hide(gameSection); show(dashboard);
      }, 3000);
    } else {
      gameStatus.textContent = d.turn === player ? "Your turn" : "Opponent's turn";
    }
  });
}

function renderBoard(board) {
  gameBoard.innerHTML = "";
  board.forEach((val, i) => {
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.textContent = val;
    if (!val && gameStatus.textContent === "Your turn") {
      cell.onclick = () => makeMove(i);
    }
    gameBoard.appendChild(cell);
  });
}

async function makeMove(i) {
  const ref = doc(db, "rooms", roomId);
  const snap = await getDoc(ref);
  const d = snap.data();
  if (d.turn !== player || d.board[i]) return;
  d.board[i] = player;
  d.turn = player === "X" ? "O" : "X";
  d.winner = checkWinner(d.board);
  await updateDoc(ref, d);
}

function checkWinner(b) {
  const lines = [
    [0,1,2], [3,4,5], [6,7,8],
    [0,3,6], [1,4,7], [2,5,8],
    [0,4,8], [2,4,6]
  ];
  for (let [a,b1,c] of lines) {
    if (b[a] && b[a] === b[b1] && b[a] === b[c]) return b[a];
  }
  return b.includes("") ? "" : "Tie";
}

async function updateStats(winner) {
  const userRef = doc(db, "users", currentUser.uid);
  let update = { games: increment(1) };
  if (winner === "Tie") update.ties = increment(1);
  else if (winner === player) update.wins = increment(1);
  else update.losses = increment(1);
  await updateDoc(userRef, update);
  const snap = await getDoc(userRef);
  const d = snap.data();
  stats.textContent = `Games: ${d.games}, Wins: ${d.wins}, Losses: ${d.losses}, Ties: ${d.ties}`;
}

</script>

</body>
</html>
