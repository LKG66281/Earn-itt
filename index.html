<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Tic-Tac-Toe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/Babel.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1C2526 0%, #2A2E6B 100%);
            background-size: 200% 200%;
            animation: gradientWave 15s ease infinite;
            font-family: 'Montserrat', sans-serif;
        }
        @keyframes gradientWave {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
    <div id="root" class="w-full max-w-md"></div>

    <script type="text/babel">
        // Firebase Configuration - REPLACE WITH YOUR OWN
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCxUwcTWRApLE7F_LHMXHOrmoQVWabfpgA",
  authDomain: "future-4a5bb.firebaseapp.com",
  projectId: "future-4a5bb",
  storageBucket: "future-4a5bb.firebasestorage.app",
  messagingSenderId: "769026893150",
  appId: "1:769026893150:web:a45882a2d5336b58d09bcf",
  measurementId: "G-C13FSB81CT"
};

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Utility Components
        const Message = ({ message, type, onClose }) => {
            React.useEffect(() => {
                const timer = setTimeout(() => onClose(), 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            return (
                <div className={`fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 px-8 py-4 rounded-lg text-white shadow-lg transition-opacity duration-300 ${type === 'success' ? 'bg-gradient-to-r from-green-400 to-teal-500' : 'bg-gradient-to-r from-red-500 to-orange-500'}`}>
                    {message}
                </div>
            );
        };

        // Auth Component
        const Auth = ({ setUser }) => {
            const [isSignUp, setIsSignUp] = React.useState(true);
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [message, setMessage] = React.useState(null);
            const [showReset, setShowReset] = React.useState(false);
            const [resetEmail, setResetEmail] = React.useState('');

            const handleAuth = async () => {
                if (!email || !password) {
                    setMessage({ text: 'Please enter email and password', type: 'error' });
                    return;
                }
                try {
                    if (isSignUp) {
                        const { user } = await auth.createUserWithEmailAndPassword(email, password);
                        await db.collection('users').doc(user.uid).set({ username: 'Player', avatar: '' });
                        await user.sendEmailVerification();
                        setMessage({ text: 'Sign Up Successful! Please verify your email.', type: 'success' });
                    } else {
                        await auth.signInWithEmailAndPassword(email, password);
                        setMessage({ text: 'Login Successful!', type: 'success' });
                    }
                    setEmail('');
                    setPassword('');
                } catch (error) {
                    setMessage({ text: `Error: ${error.message}`, type: 'error' });
                }
            };

            const handleReset = async () => {
                if (!resetEmail) {
                    setMessage({ text: 'Please enter an email', type: 'error' });
                    return;
                }
                try {
                    await auth.sendPasswordResetEmail(resetEmail);
                    setMessage({ text: 'Password reset link sent!', type: 'success' });
                    setShowReset(false);
                    setResetEmail('');
                } catch (error) {
                    setMessage({ text: `Error: ${error.message}`, type: 'error' });
                }
            };

            return (
                <div className="bg-gray-800 bg-opacity-90 p-8 rounded-2xl shadow-lg backdrop-blur-lg border border-green-400/20 fade-in">
                    <h2 className="text-2xl font-bold text-yellow-400 mb-6">{showReset ? 'Reset Password' : isSignUp ? 'Sign Up' : 'Login'}</h2>
                    {showReset ? (
                        <>
                            <p className="text-white mb-4">Enter your email to receive a reset link.</p>
                            <input
                                type="email"
                                value={resetEmail}
                                onChange={(e) => setResetEmail(e.target.value)}
                                placeholder="Email"
                                className="w-full p-3 mb-4 bg-gray-700 rounded-full text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                            <button
                                onClick={handleReset}
                                className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white font-semibold hover:from-green-400 hover:to-teal-500 transition-all"
                            >
                                Send Reset Link
                            </button>
                            <span
                                className="text-green-400 cursor-pointer mt-4 inline-block"
                                onClick={() => setShowReset(false)}
                            >
                                Back to Login
                            </span>
                        </>
                    ) : (
                        <>
                            <input
                                type="email"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                placeholder="Email"
                                className="w-full p-3 mb-4 bg-gray-700 rounded-full text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                            <input
                                type="password"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                placeholder="Password"
                                className="w-full p-3 mb-4 bg-gray-700 rounded-full text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                            <button
                                onClick={handleAuth}
                                className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white font-semibold hover:from-green-400 hover:to-teal-500 transition-all"
                            >
                                {isSignUp ? 'Sign Up' : 'Login'}
                            </button>
                            <span
                                className="text-green-400 cursor-pointer mt-4 inline-block"
                                onClick={() => setIsSignUp(!isSignUp)}
                            >
                                {isSignUp ? 'Already have an account? Login' : 'Need an account? Sign Up'}
                            </span>
                            {!isSignUp && (
                                <span
                                    className="text-green-400 cursor-pointer mt-2 inline-block"
                                    onClick={() => setShowReset(true)}
                                >
                                    Forgot Password?
                                </span>
                            )}
                        </>
                    )}
                    {message && (
                        <Message
                            message={message.text}
                            type={message.type}
                            onClose={() => setMessage(null)}
                        />
                    )}
                </div>
            );
        };

        // Dashboard Component
        const Dashboard = ({ user, setView }) => {
            const [message, setMessage] = React.useState(null);

            const handleLogout = async () => {
                await auth.signOut();
                setMessage({ text: 'Logged out successfully!', type: 'success' });
            };

            return (
                <div className="bg-gray-800 bg-opacity-90 p-8 rounded-2xl shadow-lg backdrop-blur-lg border border-green-400/20 fade-in w-full max-w-4xl">
                    <div className="flex items-center mb-6">
                        <div
                            className="w-16 h-16 rounded-full bg-gray-700 border-2 border-purple-600 flex items-center justify-center text-yellow-400 text-2xl cursor-pointer hover:scale-110 transition-all"
                            onClick={() => setView('profile')}
                        >
                            {user.avatar ? <img src={user.avatar} alt="Avatar" className="w-full h-full rounded-full object-cover" /> : user.username[0].toUpperCase()}
                        </div>
                        <div className="ml-4">
                            <h2 className="text-xl font-bold text-yellow-400">{user.username}</h2>
                            <p className="text-green-400">Balance: ₹0</p>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-gray-900 p-6 rounded-lg border-2 border-blue-500 hover:border-green-400 hover:-translate-y-1 transition-all">
                            <h3 className="text-lg font-semibold text-white mb-4">Tasks</h3>
                            <p className="text-white">Coming soon!</p>
                        </div>
                        <div className="bg-gray-900 p-6 rounded-lg border-2 border-blue-500 hover:border-green-400 hover:-translate-y-1 transition-all">
                            <h3 className="text-lg font-semibold text-white mb-4">Play</h3>
                            <button
                                onClick={() => setView('random')}
                                className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white font-semibold hover:from-green-400 hover:to-teal-500 transition-all"
                            >
                                Start Match
                            </button>
                        </div>
                        <div className="bg-gray-900 p-6 rounded-lg border-2 border-blue-500 hover:border-green-400 hover:-translate-y-1 transition-all">
                            <h3 className="text-lg font-semibold text-white mb-4">Play with Friend</h3>
                            <button
                                onClick={() => setView('friend')}
                                className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white font-semibold hover:from-green-400 hover:to-teal-500 transition-all"
                            >
                                Invite Friend
                            </button>
                        </div>
                    </div>
                    <button
                        onClick={handleLogout}
                        className="mt-6 w-full p-3 bg-red-600 rounded-lg text-white font-semibold hover:bg-red-700 transition-all"
                    >
                        Logout
                    </button>
                    {message && (
                        <Message
                            message={message.text}
                            type={message.type}
                            onClose={() => setMessage(null)}
                        />
                    )}
                </div>
            );
        };

        // Game Mode Selection
        const GameMode = ({ user, setView }) => {
            const [roomId, setRoomId] = React.useState('');
            const [message, setMessage] = React.useState(null);

            const createRoom = async () => {
                try {
                    const roomData = {
                        player1: user.uid,
                        player1Username: user.username,
                        player1Avatar: user.avatar || '',
                        player2: null,
                        player2Username: null,
                        player2Avatar: null,
                        board: ['', '', '', '', '', '', '', '', ''],
                        turn: 'X',
                        status: 'waiting',
                        createdAt: Date.now()
                    };
                    const roomRef = await db.collection('rooms').add(roomData);
                    setView({ view: 'game', roomId: roomRef.id, player: 'X' });
                    setMessage({ text: `Room created! Share ID: ${roomRef.id}`, type: 'success' });
                } catch (error) {
                    setMessage({ text: `Error: ${error.message}`, type: 'error' });
                }
            };

            const joinRoom = async () => {
                if (!roomId) {
                    setMessage({ text: 'Please enter a Room ID', type: 'error' });
                    return;
                }
                try {
                    const roomDoc = await db.collection('rooms').doc(roomId).get();
                    if (!roomDoc.exists) {
                        setMessage({ text: 'Room not found', type: 'error' });
                        return;
                    }
                    const roomData = roomDoc.data();
                    if (roomData.player2) {
                        setMessage({ text: 'Room is full', type: 'error' });
                        return;
                    }
                    if (roomData.player1 === user.uid) {
                        setMessage({ text: 'You cannot join your own room', type: 'error' });
                        return;
                    }
                    await db.collection('rooms').doc(roomId).update({
                        player2: user.uid,
                        player2Username: user.username,
                        player2Avatar: user.avatar || '',
                        status: 'active'
                    });
                    setView({ view: 'game', roomId, player: 'O' });
                    setMessage({ text: 'Joined room successfully!', type: 'success' });
                    setRoomId('');
                } catch (error) {
                    setMessage({ text: `Error: ${error.message}`, type: 'error' });
                }
            };

            return (
                <div className="bg-gray-800 bg-opacity-90 p-8 rounded-2xl shadow-lg backdrop-blur-lg border border-green-400/20 fade-in">
                    <h2 className="text-2xl font-bold text-yellow-400 mb-6">Choose Game Mode</h2>
                    <button
                        onClick={createRoom}
                        className="w-full p-3 mb-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white font-semibold hover:from-green-400 hover:to-teal-500 transition-all"
                    >
                        Create Room
                    </button>
                    <input
                        type="text"
                        value={roomId}
                        onChange={(e) => setRoomId(e.target.value)}
                        placeholder="Enter Room ID"
                        className="w-full p-3 mb-4 bg-gray-700 rounded-full text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <button
                        onClick={joinRoom}
                        className="w-full p-3 mb-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white font-semibold hover:from-green-400 hover:to-teal-500 transition-all"
                    >
                        Join Room
                    </button>
                    <button
                        onClick={() => setView('dashboard')}
                        className="w-full p-3 bg-gray-600 rounded-lg text-white font-semibold hover:bg-gray-700 transition-all"
                    >
                        Back to Dashboard
                    </button>
                    {message && (
                        <Message
                            message={message.text}
                            type={message.type}
                            onClose={() => setMessage(null)}
                        />
                    )}
                </div>
            );
        };

        // Game Component
        const Game = ({ user, roomId, player, setView }) => {
            const [board, setBoard] = React.useState(['', '', '', '', '', '', '', '', '']);
            const [turn, setTurn] = React.useState('X');
            const [status, setStatus] = React.useState('Waiting for opponent...');
            const [players, setPlayers] = React.useState({ player1: {}, player2: {} });
            const [message, setMessage] = React.useState(null);

            React.useEffect(() => {
                const unsubscribe = db.collection('rooms').doc(roomId).onSnapshot(async (doc) => {
                    if (!doc.exists) {
                        setMessage({ text: 'Room closed', type: 'error' });
                        setView('dashboard');
                        return;
                    }
                    const data = doc.data();
                    setBoard(data.board);
                    setTurn(data.turn);
                    setPlayers({
                        player1: { uid: data.player1, username: data.player1Username, avatar: data.player1Avatar },
                        player2: { uid: data.player2, username: data.player2Username, avatar: data.player2Avatar }
                    });
                    if (data.status === 'active' && data.player1 && data.player2) {
                        setStatus(data.turn === player ? 'Your turn' : "Opponent's turn");
                        const winner = data.winner || checkWinner(data.board);
                        if (winner && !data.winner) {
                            await db.collection('rooms').doc(roomId).update({ winner, status: 'finished' });
                        }
                        if (winner) {
                            await handleGameEnd(winner);
                        }
                    } else {
                        setStatus('Waiting for opponent...');
                    }
                });
                return () => unsubscribe();
            }, [roomId, player]);

            const checkWinner = (board) => {
                const winPatterns = [
                    [0, 1, 2], [3, 4, 5], [6, 7, 8],
                    [0, 3, 6], [1, 4, 7], [2, 5, 8],
                    [0, 4, 8], [2, 4, 6]
                ];
                for (const [a, b, c] of winPatterns) {
                    if (board[a] && board[a] === board[b] && board[b] === board[c]) {
                        return board[a];
                    }
                }
                return board.every(cell => cell !== '') ? 'tie' : null;
            };

            const handleCellClick = async (index) => {
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                const data = roomDoc.data();
                if (data.board[index] !== '' || data.winner || data.status !== 'active' || turn !== player) {
                    setMessage({ text: 'Invalid move!', type: 'error' });
                    return;
                }
                const newBoard = [...data.board];
                newBoard[index] = player;
                const newTurn = player === 'X' ? 'O' : 'X';
                await db.collection('rooms').doc(roomId).update({ board: newBoard, turn: newTurn });
            };

            const handleGameEnd = async (result) => {
                const historyData = {
                    result: result === player ? 'win' : result === 'tie' ? 'tie' : 'loss',
                    opponent: player === 'X' ? players.player2.username : players.player1.username,
                    timestamp: Date.now()
                };
                await db.collection('users').doc(user.uid).collection('gameHistory').add(historyData);
                setMessage({
                    text: result === player ? 'You won!' : result === 'tie' ? 'Game tied!' : `${player === 'X' ? players.player2.username : players.player1.username} won!`,
                    type: result === player || result === 'tie' ? 'success' : 'error'
                });
                setTimeout(() => setView('dashboard'), 2000);
            };

            const leaveRoom = async () => {
                await db.collection('rooms').doc(roomId).update({ status: 'closed' });
                setView('dashboard');
                setMessage({ text: 'Left room', type: 'success' });
            };

            return (
                <div className="bg-gray-800 bg-opacity-90 p-8 rounded-2xl shadow-lg backdrop-blur-lg border border-green-400/20 fade-in">
                    <h2 className="text-2xl font-bold text-yellow-400 mb-6">Tic-Tac-Toe</h2>
                    <p className="text-yellow-400 mb-4">Room ID: {roomId}</p>
                    <div className="flex justify-between mb-6">
                        <div className="flex flex-col items-center">
                            <div className="w-12 h-12 rounded-full bg-gray-700 border-2 border-purple-600 flex items-center justify-center text-yellow-400 text-xl">
                                {players.player1.avatar ? <img src={players.player1.avatar} alt="Avatar" className="w-full h-full rounded-full object-cover" /> : players.player1.username?.[0]?.toUpperCase() || 'P'}
                            </div>
                            <span className="text-white mt-2">{players.player1.username || 'Player 1'}</span>
                        </div>
                        <div className="flex flex-col items-center">
                            <div className="w-12 h-12 rounded-full bg-gray-700 border-2 border-purple-600 flex items-center justify-center text-yellow-400 text-xl">
                                {players.player2.avatar ? <img src={players.player2.avatar} alt="Avatar" className="w-full h-full rounded-full object-cover" /> : players.player2.username?.[0]?.toUpperCase() || 'P'}
                            </div>
                            <span className="text-white mt-2">{players.player2.username || 'Waiting...'}</span>
                        </div>
                    </div>
                    <p className="text-yellow-400 mb-6">{status}</p>
                    <div className="grid grid-cols-3 gap-4 w-80 mx-auto">
                        {board.map((cell, index) => (
                            <div
                                key={index}
                                onClick={() => handleCellClick(index)}
                                className={`w-24 h-24 bg-gray-900 border-2 border-purple-600 rounded-lg flex items-center justify-center text-4xl cursor-pointer hover:bg-purple-800 transition-all ${cell === 'X' ? 'text-yellow-400' : cell === 'O' ? 'text-green-400' : ''}`}
                            >
                                {cell}
                            </div>
                        ))}
                    </div>
                    <button
                        onClick={leaveRoom}
                        className="mt-6 w-full p-3 bg-red-600 rounded-lg text-white font-semibold hover:bg-red-700 transition-all"
                    >
                        Leave Room
                    </button>
                    {message && (
                        <Message
                            message={message.text}
                            type={message.type}
                            onClose={() => setMessage(null)}
                        />
                    )}
                </div>
            );
        };

        // Profile Component
        const Profile = ({ user, setView }) => {
            const [username, setUsername] = React.useState(user.username);
            const [avatarFile, setAvatarFile] = React.useState(null);
            const [message, setMessage] = React.useState(null);
            const [history, setHistory] = React.useState([]);
            const [showHistory, setShowHistory] = React.useState(false);

            const handleAvatarChange = (e) => {
                const file = e.target.files[0];
                if (file && file.size <= 2 * 1024 * 1024) {
                    setAvatarFile(file);
                } else {
                    setMessage({ text: 'Image must be under 2MB', type: 'error' });
                }
            };

            const saveProfile = async () => {
                if (!username.trim()) {
                    setMessage({ text: 'Username cannot be empty', type: 'error' });
                    return;
                }
                try {
                    let avatarUrl = user.avatar;
                    if (avatarFile) {
                        const storageRef = storage.ref(`avatars/${user.uid}`);
                        await storageRef.put(avatarFile);
                        avatarUrl = await storageRef.getDownloadURL();
                    }
                    await db.collection('users').doc(user.uid).update({ username, avatar: avatarUrl });
                    setMessage({ text: 'Profile updated successfully!', type: 'success' });
                    setView('dashboard');
                } catch (error) {
                    setMessage({ text: `Error: ${error.message}`, type: 'error' });
                }
            };

            const viewHistory = async () => {
                try {
                    const snapshot = await db.collection('users').doc(user.uid).collection('gameHistory').get();
                    const matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setHistory(matches);
                    setShowHistory(true);
                } catch (error) {
                    setMessage({ text: `Error: ${error.message}`, type: 'error' });
                }
            };

            return (
                <div className="bg-gray-800 bg-opacity-90 p-8 rounded-2xl shadow-lg backdrop-blur-lg border border-green-400/20 fade-in">
                    <h2 className="text-2xl font-bold text-yellow-400 mb-6">Edit Profile</h2>
                    {showHistory ? (
                        <>
                            <h3 className="text-lg font-semibold text-white mb-4">Game History</h3>
                            <div className="max-h-80 overflow-y-auto">
                                {history.length === 0 ? (
                                    <p className="text-white">No matches yet.</p>
                                ) : (
                                    history.map(match => (
                                        <div
                                            key={match.id}
                                            className={`p-4 mb-4 rounded-lg border-2 ${match.result === 'win' ? 'border-yellow-400' : match.result === 'loss' ? 'border-red-500' : 'border-green-400'}`}
                                        >
                                            <p className="text-white">Result: {match.result.charAt(0).toUpperCase() + match.result.slice(1)}</p>
                                            <p className="text-white">Opponent: {match.opponent || 'Random'}</p>
                                            <p className="text-white">Time: {new Date(match.timestamp).toLocaleString()}</p>
                                        </div>
                                    ))
                                )}
                            </div>
                            <button
                                onClick={() => setShowHistory(false)}
                                className="w-full p-3 bg-gray-600 rounded-lg text-white font-semibold hover:bg-gray-700 transition-all"
                            >
                                Back to Profile
                            </button>
                        </>
                    ) : (
                        <>
                            <div
                                className="w-24 h-24 rounded-full bg-gray-700 border-2 border-purple-600 flex items-center justify-center text-yellow-400 text-4xl mx-auto mb-4 cursor-pointer hover:scale-110 transition-all"
                                onClick={() => document.getElementById('avatarUpload').click()}
                            >
                                {avatarFile ? (
                                    <img src={URL.createObjectURL(avatarFile)} alt="Avatar" className="w-full h-full rounded-full object-cover" />
                                ) : user.avatar ? (
                                    <img src={user.avatar} alt="Avatar" className="w-full h-full rounded-full object-cover" />
                                ) : (
                                    username[0].toUpperCase()
                                )}
                            </div>
                            <input
                                type="file"
                                id="avatarUpload"
                                accept="image/*"
                                onChange={handleAvatarChange}
                                className="hidden"
                            />
                            <input
                                type="text"
                                value={username}
                                onChange={(e) => setUsername(e.target.value)}
                                className="w-full p-3 mb-4 bg-gray-700 rounded-full text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                            />
                            <button
                                onClick={saveProfile}
                                className="w-full p-3 mb-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white font-semibold hover:from-green-400 hover:to-teal-500 transition-all"
                            >
                                Save Changes
                            </button>
                            <button
                                onClick={viewHistory}
                                className="w-full p-3 mb-4 bg-gray-600 rounded-lg text-white font-semibold hover:bg-gray-700 transition-all"
                            >
                                View Game History
                            </button>
                            <button
                                onClick={() => setView('dashboard')}
                                className="w-full p-3 bg-gray-600 rounded-lg text-white font-semibold hover:bg-gray-700 transition-all"
                            >
                                Back to Dashboard
                            </button>
                        </>
                    )}
                    {message && (
                        <Message
                            message={message.text}
                            type={message.type}
                            onClose={() => setMessage(null)}
                        />
                    )}
                </div>
            );
        };

        // Verify Email Component
        const VerifyEmail = ({ user }) => {
            const [message, setMessage] = React.useState(null);

            const resendVerification = async () => {
                try {
                    await user.sendEmailVerification();
                    setMessage({ text: 'Verification email resent!', type: 'success' });
                } catch (error) {
                    setMessage({ text: `Error: ${error.message}`, type: 'error' });
                }
            };

            const handleLogout = async () => {
                await auth.signOut();
                setMessage({ text: 'Logged out successfully!', type: 'success' });
            };

            return (
                <div className="bg-gray-800 bg-opacity-90 p-8 rounded-2xl shadow-lg backdrop-blur-lg border border-green-400/20 fade-in">
                    <h2 className="text-2xl font-bold text-yellow-400 mb-6">Email Verification</h2>
                    <p className="text-white mb-6">Please check your inbox to verify your email address.</p>
                    <button
                        onClick={resendVerification}
                        className="w-full p-3 mb-4 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg text-white font-semibold hover:from-green-400 hover:to-teal-500 transition-all"
                    >
                        Resend Verification Email
                    </button>
                    <button
                        onClick={handleLogout}
                        className="w-full p-3 bg-red-600 rounded-lg text-white font-semibold hover:bg-red-700 transition-all"
                    >
                        Logout
                    </button>
                    {message && (
                        <Message
                            message={message.text}
                            type={message.type}
                            onClose={() => setMessage(null)}
                        />
                    )}
                </div>
            );
        };

        // Random Match Component
        const RandomMatch = ({ user, setView }) => {
            const [message, setMessage] = React.useState(null);

            React.useEffect(() => {
                let unsubscribe;
                const startMatch = async () => {
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        const userData = userDoc.data();
                        const matchmakingData = {
                            userId: user.uid,
                            username: userData.username,
                            avatar: userData.avatar || '',
                            status: 'waiting',
                            timestamp: Date.now()
                        };
                        const matchmakingRef = await db.collection('matchmaking').add(matchmakingData);
                        let isPaired = false;

                        unsubscribe = db.collection('matchmaking').doc(matchmakingRef.id).onSnapshot(async (doc) => {
                            if (!doc.exists) {
                                if (!isPaired) {
                                    setView('dashboard');
                                    setMessage({ text: 'Matchmaking canceled.', type: 'error' });
                                }
                                return;
                            }
                            const data = doc.data();
                            if (data.status === 'paired' && data.roomId) {
                                isPaired = true;
                                await db.collection('matchmaking').doc(matchmakingRef.id).delete();
                                setView({ view: 'game', roomId: data.roomId, player: data.playerSymbol });
                                setMessage({ text: 'Opponent found! Game started.', type: 'success' });
                            }
                        });

                        const existingEntries = await db.collection('matchmaking').where('status', '==', 'waiting').get();
                        const opponentDocs = existingEntries.docs.filter(doc => doc.data().userId !== user.uid && (Date.now() - doc.data().timestamp) < 20000);

                        if (opponentDocs.length > 0 && !isPaired) {
                            const opponent = opponentDocs[0].data();
                            isPaired = true;
                            const roomData = {
                                player1: user.uid,
                                player1Username: userData.username,
                                player1Avatar: userData.avatar || '',
                                player2: opponent.userId,
                                player2Username: opponent.username,
                                player2Avatar: opponent.avatar || '',
                                board: ['', '', '', '', '', '', '', '', ''],
                                turn: 'X',
                                status: 'active',
                                createdAt: Date.now()
                            };
                            const roomRef = await db.collection('rooms').add(roomData);
                            await db.collection('matchmaking').doc(opponentDocs[0].id).update({
                                status: 'paired',
                                roomId: roomRef.id,
                                playerSymbol: 'O',
                                opponentUsername: userData.username
                            });
                            await db.collection('matchmaking').doc(matchmakingRef.id).delete();
                            setView({ view: 'game', roomId: roomRef.id, player: 'X' });
                            setMessage({ text: 'Opponent found! Game started.', type: 'success' });
                        } else {
                            setTimeout(() => {
                                if (!isPaired) {
                                    unsubscribe();
                                    db.collection('matchmaking').doc(matchmakingRef.id).delete();
                                    setView('dashboard');
                                    setMessage({ text: 'No opponent found. Try again.', type: 'error' });
                                }
                            }, 20000);
                        }
                    } catch (error) {
                        setMessage({ text: 'Matchmaking failed.', type: 'error' });
                        setView('dashboard');
                    }
                };
                startMatch();
                return () => unsubscribe && unsubscribe();
            }, [user, setView]);

            return (
                <div className="bg-gray-800 bg-opacity-90 p-8 rounded-2xl shadow-lg backdrop-blur-lg border border-green-400/20 fade-in">
                    <h2 className="text-2xl font-bold text-yellow-400 mb-6">Matchmaking</h2>
                    <p className="text-yellow-400 pulse">Searching for opponent...</p>
                    {message && (
                        <Message
                            message={message.text}
                            type={message.type}
                            onClose={() => setMessage(null)}
                        />
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('auth');
            const [roomId, setRoomId] = React.useState(null);
            const [player, setPlayer] = React.useState(null);

            React.useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (authUser) => {
                    if (authUser) {
                        if (!authUser.emailVerified) {
                            setView('verify');
                            setUser(authUser);
                            return;
                        }
                        const userDoc = await db.collection('users').doc(authUser.uid).get();
                        const userData = userDoc.data();
                        setUser({ uid: authUser.uid, ...userData });
                        setView('dashboard');
                    } else {
                        setUser(null);
                        setView('auth');
                    }
                });
                return () => unsubscribe();
            }, []);

            const handleSetView = (newView) => {
                if (typeof newView === 'object') {
                    setView(newView.view);
                    setRoomId(newView.roomId);
                    setPlayer(newView.player);
                } else {
                    setView(newView);
                    setRoomId(null);
                    setPlayer(null);
                }
            };

            return (
                <>
                    {view === 'auth' && <Auth setUser={setUser} />}
                    {view === 'verify' && user && <VerifyEmail user={user} />}
                    {view === 'dashboard' && user && <Dashboard user={user} setView={handleSetView} />}
                    {view === 'friend' && user && <GameMode user={user} setView={handleSetView} />}
                    {view === 'random' && user && <RandomMatch user={user} setView={handleSetView} />}
                    {view === 'game' && user && roomId && player && (
                        <Game user={user} roomId={roomId} player={player} setView={handleSetView} />
                    )}
                    {view === 'profile' && user && <Profile user={user} setView={handleSetView} />}
                </>
            );
        };

        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
