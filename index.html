<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDptrY_22JlFegSAzXU52Wg8Wu6TUXqqjI",
            authDomain: "earn-it-7d72d.firebaseapp.com",
            projectId: "earn-it-7d72d",
            storageBucket: "earn-it-7d72d.appspot.com",
            messagingSenderId: "1756161084",
            appId: "1:1756161084:web:3db1e0d934ac844ed28f39",
            measurementId: "G-J98NDHW03J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // UI Elements
        const authDiv = document.getElementById("auth");
        const dashboardDiv = document.getElementById("dashboard");
        const usernameSpan = document.getElementById("username");
        const gamesPlayedSpan = document.getElementById("gamesPlayed");
        const winsSpan = document.getElementById("wins");
        const lossesSpan = document.getElementById("losses");

        // Signup & Login
        document.getElementById("signup").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const userCred = await createUserWithEmailAndPassword(auth, email, password);
            await setDoc(doc(db, "users", userCred.user.uid), { email, gamesPlayed: 0, wins: 0, losses: 0 });
            showDashboard(userCred.user);
        });

        document.getElementById("login").addEventListener("click", async () => {
            const email = document.getElementById("email").value;
            const password = document.getElementById("password").value;
            const userCred = await signInWithEmailAndPassword(auth, email, password);
            showDashboard(userCred.user);
        });

        document.getElementById("google-login").addEventListener("click", async () => {
            const userCred = await signInWithPopup(auth, provider);
            const userRef = doc(db, "users", userCred.user.uid);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                await setDoc(userRef, { email: userCred.user.email, gamesPlayed: 0, wins: 0, losses: 0 });
            }
            showDashboard(userCred.user);
        });

        document.getElementById("logout").addEventListener("click", async () => {
            await signOut(auth);
            authDiv.style.display = "block";
            dashboardDiv.style.display = "none";
        });

        function showDashboard(user) {
            authDiv.style.display = "none";
            dashboardDiv.style.display = "block";
            usernameSpan.innerText = user.email;
        }

        // Matchmaking
        document.getElementById("play-btn").addEventListener("click", async () => {
            const user = auth.currentUser;
            if (!user) return;

            const q = query(collection(db, "games"), where("status", "==", "waiting"));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                const gameDoc = querySnapshot.docs[0];
                await updateDoc(gameDoc.ref, { player2: user.uid, status: "playing" });
                startGame(gameDoc.id, "O");
            } else {
                const newGameRef = await addDoc(collection(db, "games"), { player1: user.uid, status: "waiting", board: ["", "", "", "", "", "", "", "", ""] });
                startGame(newGameRef.id, "X");
            }
        });

        function startGame(gameId, symbol) {
            document.getElementById("gameId").innerText = gameId;
            document.getElementById("game").style.display = "block";

            document.querySelectorAll(".cell").forEach((cell, index) => {
                cell.addEventListener("click", async () => {
                    if (!cell.innerText) {
                        const gameRef = doc(db, "games", gameId);
                        const gameSnap = await getDoc(gameRef);
                        const board = gameSnap.data().board;
                        board[index] = symbol;
                        await updateDoc(gameRef, { board });
                        cell.innerText = symbol;
                    }
                });
            });
        }
    </script>
    <style>
        .board { display: grid; grid-template-columns: repeat(3, 60px); gap: 5px; }
        .cell { width: 60px; height: 60px; background: lightgray; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth">
        <h2>Login / Signup</h2>
        <button id="google-login">Login with Google</button>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button id="signup">Sign Up</button>
        <button id="login">Login</button>
    </div>

    <div id="dashboard" style="display: none;">
        <h2>Welcome, <span id="username"></span>!</h2>
        <button id="play-btn">Play</button>
        <button id="logout">Logout</button>
        <h3>Games: <span id="gamesPlayed">0</span> | Wins: <span id="wins">0</span> | Losses: <span id="losses">0</span></h3>
        
        <div id="game" style="display: none;">
            <h3>Game ID: <span id="gameId"></span></h3>
            <div class="board">
                <div class="cell" data-index="0"></div>
                <div class="cell" data-index="1"></div>
                <div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div>
                <div class="cell" data-index="4"></div>
                <div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div>
                <div class="cell" data-index="7"></div>
                <div class="cell" data-index="8"></div>
            </div>
        </div>
    </div>

</body>
</html>
