<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Neon Tic-Tac-Toe</title>
  <style>
    body {
      background-color: #000;
      color: #0ff;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }

    .container {
      width: 90%;
      max-width: 600px;
      text-align: center;
    }

    input, button {
      padding: 10px 20px;
      margin: 10px;
      background: transparent;
      border: 2px solid #0ff;
      color: #0ff;
      font-size: 1em;
      border-radius: 8px;
      transition: 0.3s;
    }

    button:hover, input:focus {
      background-color: #0ff;
      color: #000;
      outline: none;
    }

    .hidden {
      display: none;
    }

    .game-board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 5px;
      justify-content: center;
      margin: 20px auto;
    }

    .cell {
      width: 100px;
      height: 100px;
      background-color: #111;
      border: 2px solid #0ff;
      font-size: 2em;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    #messageBox {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 255, 255, 0.2);
      border: 1px solid #0ff;
      padding: 10px 20px;
      border-radius: 10px;
      color: #0ff;
      font-weight: bold;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="messageBox"></div>
  <div class="container" id="dashboard">
    <!-- MAIN DASHBOARD -->
    <div id="mainDashboard">
      <h2>Welcome, <span id="usernameDisplay">Player</span> ðŸŽ®</h2>
      <input type="text" id="usernameInput" placeholder="Set or change your username"/>
      <button onclick="saveUsername()">Save Username</button>
      <button onclick="goToGameMenu()">Play</button>
      <button onclick="logout()">Logout</button>
    </div>

    <!-- GAME MENU -->
    <div id="gameMenu" class="hidden">
      <h2>Select Game Mode</h2>
      <button onclick="showFriendOptions()">Play with Friend</button>
      <button onclick="startMatchmaking()">Play with Random Player</button>
      <button onclick="showSection('mainDashboard')">Back</button>
    </div>

    <!-- FRIEND OPTIONS -->
    <div id="friendOptions" class="hidden">
      <h2>Play With Friend</h2>
      <button onclick="createRoom()">Create Room</button>
      <button onclick="joinRoomPrompt()">Join Room</button>
      <button onclick="showSection('gameMenu')">Back</button>
    </div>

    <!-- GAME ROOM -->
    <div id="gameRoom" class="hidden"></div>
  </div>

  <!-- Firebase + JS -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    // Your Firebase config here
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const dashboard = document.getElementById("dashboard");

    function showMessage(text) {
      const msg = document.getElementById("messageBox");
      msg.innerText = text;
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 3000);
    }

    function showSection(id) {
      ['mainDashboard', 'gameMenu', 'friendOptions', 'gameRoom'].forEach(sec => {
        document.getElementById(sec).classList.add('hidden');
      });
      document.getElementById(id).classList.remove('hidden');
    }

    function saveUsername() {
      const username = document.getElementById("usernameInput").value.trim();
      if (username) {
        const user = auth.currentUser;
        db.collection("users").doc(user.uid).set({ username }, { merge: true });
        document.getElementById("usernameDisplay").innerText = username;
        showMessage("Username saved!");
      }
    }

    function goToGameMenu() {
      showSection('gameMenu');
    }

    function showFriendOptions() {
      showSection('friendOptions');
    }

    function createRoom() {
      const roomRef = db.collection("rooms").doc();
      const user = auth.currentUser;
      roomRef.set({ players: [user.uid] });
      waitForFriend(roomRef.id);
    }

    function joinRoomPrompt() {
      const roomId = prompt("Enter Room ID:");
      if (roomId) {
        joinRoom(roomId);
      }
    }

    function joinRoom(roomId) {
      const roomRef = db.collection("rooms").doc(roomId);
      roomRef.get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          if (data.players.length < 2) {
            roomRef.update({ players: [...data.players, auth.currentUser.uid] });
            launchGame(roomId);
          } else {
            showMessage("Room is full.");
          }
        } else {
          showMessage("Room not found.");
        }
      });
    }

    function waitForFriend(roomId) {
      const unsub = db.collection("rooms").doc(roomId).onSnapshot(doc => {
        const data = doc.data();
        if (data.players.length === 2) {
          unsub();
          launchGame(roomId);
        }
      });
      showSection('gameRoom');
      document.getElementById("gameRoom").innerHTML = `<h2>Waiting for friend...</h2><div>Room ID: ${roomId}</div><button onclick="location.reload()">Cancel</button>`;
    }

    function startMatchmaking() {
      const user = auth.currentUser;
      const queueRef = db.collection("matchmaking").doc(user.uid);
      queueRef.set({ timestamp: Date.now() });

      const interval = setInterval(() => {
        db.collection("matchmaking").get().then(snapshot => {
          const players = [];
          snapshot.forEach(doc => players.push(doc.id));
          if (players.length >= 2) {
            clearInterval(interval);
            const [p1, p2] = players;
            const roomRef = db.collection("rooms").doc();
            roomRef.set({ players: [p1, p2] });
            db.collection("matchmaking").doc(p1).delete();
            db.collection("matchmaking").doc(p2).delete();
            if (user.uid === p1 || user.uid === p2) {
              launchGame(roomRef.id);
            }
          }
        });
      }, 1000);

      showMessage("Searching for opponent...");
    }

    function launchGame(roomId) {
      showSection('gameRoom');
      document.getElementById("gameRoom").innerHTML = `<h2>Tic-Tac-Toe</h2><div id="gameStatus">Loading...</div><div class="game-board" id="gameBoard"></div><button onclick="location.reload()">Exit</button>`;
      initGame(roomId);
    }

    function initGame(roomId) {
      const user = auth.currentUser;
      const boardEl = document.getElementById("gameBoard");
      const statusEl = document.getElementById("gameStatus");

      const roomRef = db.collection("rooms").doc(roomId);

      roomRef.get().then(doc => {
        const data = doc.data();
        const [playerX, playerO] = data.players;
        const symbol = user.uid === playerX ? "X" : "O";

        let board = Array(9).fill("");
        let turn = "X";
        roomRef.set({ board, turn }, { merge: true });

        roomRef.onSnapshot(doc => {
          const data = doc.data();
          board = data.board;
          turn = data.turn;

          boardEl.innerHTML = "";
          board.forEach((cell, i) => {
            const div = document.createElement("div");
            div.className = "cell";
            div.innerText = cell;
            if (!cell && symbol === turn) {
              div.onclick = () => {
                board[i] = symbol;
                const nextTurn = symbol === "X" ? "O" : "X";
                roomRef.set({ board, turn: nextTurn }, { merge: true });
              };
            }
            boardEl.appendChild(div);
          });

          const winner = getWinner(board);
          if (winner) {
            statusEl.innerText = winner === "T" ? "It's a Tie!" : `${winner} Wins!`;
          } else {
            statusEl.innerText = `Turn: ${turn}`;
          }
        });
      });
    }

    function getWinner(b) {
      const wins = [
        [0,1,2], [3,4,5], [6,7,8],
        [0,3,6], [1,4,7], [2,5,8],
        [0,4,8], [2,4,6]
      ];
      for (const [a,b,c] of wins) {
        if (b[a] && b[a] === b[b] && b[a] === b[c]) return b[a];
      }
      return b.includes("") ? null : "T";
    }

    function logout() {
      auth.signOut().then(() => location.reload());
    }

    auth.onAuthStateChanged(user => {
      if (!user) {
        auth.signInAnonymously();
      } else {
        db.collection("users").doc(user.uid).get().then(doc => {
          const name = doc.exists ? doc.data().username || "Player" : "Player";
          document.getElementById("usernameDisplay").innerText = name;
        });
      }
    });
  </script>
</body>
</html>
