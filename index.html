<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neon Glow Tic-Tac-Toe</title>
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc,
      collection, addDoc, getDocs, onSnapshot, query, limit
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDs2taPm-p2O-dYdBToYwq7vZBUSDNISyg",
      authDomain: "earn-itt.firebaseapp.com",
      projectId: "earn-itt",
      storageBucket: "earn-itt.appspot.com",
      messagingSenderId: "785360520679",
      appId: "1:785360520679:web:ac2e2710ece34591a52942",
      measurementId: "G-P4Q2KYTBBM"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const qs = (id) => document.getElementById(id);
    const show = (el) => el.style.display = "block";
    const hide = (el) => el.style.display = "none";

    let currentUser = null;
    let symbol = "";
    let isMyTurn = false;
    let gameEnded = false;
    let currentRoom = null;
    let roomUnsub = null;

    function showMessage(msg) {
      const box = qs("message-box");
      box.textContent = msg;
      box.style.display = "block";
      setTimeout(() => box.style.display = "none", 3000);
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        show(qs("dashboard"));
        hide(qs("login-section"));
        hide(qs("signup-section"));

        const docRef = doc(db, "users", user.uid);
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
          await setDoc(docRef, {
            username: user.email.split("@")[0],
            wins: 0,
            losses: 0,
            ties: 0
          });
        }

        const data = (await getDoc(docRef)).data();
        qs("username").textContent = data.username;
        qs("stats").textContent = `W:${data.wins} L:${data.losses} T:${data.ties}`;
      } else {
        currentUser = null;
        show(qs("login-section"));
        hide(qs("signup-section"));
        hide(qs("dashboard"));
        hide(qs("game-section"));
      }
    });

    qs("to-signup").onclick = () => {
      hide(qs("login-section"));
      show(qs("signup-section"));
    };
    qs("to-login").onclick = () => {
      hide(qs("signup-section"));
      show(qs("login-section"));
    };

    qs("signup-btn").onclick = async () => {
      const email = qs("signup-email").value.trim();
      const pass = qs("signup-pass").value;
      if (!/^\S+@\S+\.\S+$/.test(email)) return showMessage("Enter valid email.");
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        showMessage(e.message);
      }
    };

    qs("login-btn").onclick = async () => {
      const email = qs("login-email").value.trim();
      const pass = qs("login-pass").value;
      if (!/^\S+@\S+\.\S+$/.test(email)) return showMessage("Enter valid email.");
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        showMessage(e.message);
      }
    };

    qs("logout-btn").onclick = () => signOut(auth);

    qs("update-username").onclick = async () => {
      const newName = qs("username-input").value.trim();
      if (!newName) return;
      await updateDoc(doc(db, "users", currentUser.uid), { username: newName });
      const updated = (await getDoc(doc(db, "users", currentUser.uid))).data();
      qs("username").textContent = updated.username;
      showMessage("Username updated!");
    };

    qs("play-random").onclick = () => randomMatch();
    qs("play-friend").onclick = () => {
      confirm("Create a room?")
        ? createFriendRoom()
        : joinFriendRoom();
    };

    async function updateStats(result) {
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      const data = snap.data();
      if (result === "win") data.wins++;
      else if (result === "lose") data.losses++;
      else data.ties++;
      await updateDoc(ref, data);
    }

    function updateBoard(board) {
      board.forEach((val, i) => {
        qs(`cell-${i}`).textContent = val;
      });
    }

    function checkGameOver(board) {
      const win = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (const [a,b,c] of win)
        if (board[a] && board[a] === board[b] && board[b] === board[c])
          return board[a];
      return board.includes("") ? null : "Tie";
    }

    function cellClick(i) {
      if (!isMyTurn || gameEnded) return;
      const cell = qs(`cell-${i}`);
      if (cell.textContent) return;
      cell.textContent = symbol;
      isMyTurn = false;
      updateDoc(doc(db, "rooms", currentRoom.id), {
        board: currentRoom.board.map((v, idx) => idx === i ? symbol : v),
        turn: symbol === "X" ? "O" : "X"
      });
    }

    function playGame(data) {
      currentRoom = data;
      symbol = data.X === currentUser.uid ? "X" : "O";
      isMyTurn = data.turn === symbol;
      gameEnded = false;
      show(qs("game-section"));
      hide(qs("dashboard"));
      qs("game-status").textContent = `You are ${symbol}`;
      updateBoard(data.board);

      roomUnsub = onSnapshot(doc(db, "rooms", data.id), (snap) => {
        const room = snap.data();
        currentRoom.board = room.board;
        updateBoard(room.board);
        const result = checkGameOver(room.board);
        if (result && !gameEnded) {
          gameEnded = true;
          const outcome = result === symbol ? "win" : result === "Tie" ? "tie" : "lose";
          showMessage(outcome.toUpperCase());
          updateStats(outcome);
          setTimeout(async () => {
            roomUnsub();
            await deleteDoc(doc(db, "rooms", data.id));
            show(qs("dashboard"));
            hide(qs("game-section"));
          }, 3000);
        }
        isMyTurn = room.turn === symbol;
      });
    }

    async function randomMatch() {
      showMessage("Searching...");
      const ref = collection(db, "matchmaking");
      const q = query(ref, limit(1));
      const snap = await getDocs(q);

      if (snap.empty) {
        const docRef = await addDoc(ref, { uid: currentUser.uid, timestamp: Date.now() });
        const unsub = onSnapshot(doc(db, "matchmaking", docRef.id), async (s) => {
          const d = s.data();
          if (d?.matched) {
            unsub();
            await deleteDoc(docRef);
            playGame({ id: d.roomId, ...d });
          }
        });
        setTimeout(async () => {
          const check = await getDoc(docRef);
          if (check.exists()) {
            await deleteDoc(docRef);
            showMessage("No match found.");
          }
        }, 20000);
      } else {
        const other = snap.docs[0];
        const roomRef = await addDoc(collection(db, "rooms"), {
          X: other.data().uid,
          O: currentUser.uid,
          board: Array(9).fill(""),
          turn: "X"
        });
        await updateDoc(other.ref, { matched: true, roomId: roomRef.id });
        playGame({ id: roomRef.id, X: other.data().uid, O: currentUser.uid, board: Array(9).fill(""), turn: "X" });
      }
    }

    async function createFriendRoom() {
      const roomRef = await addDoc(collection(db, "rooms"), {
        X: currentUser.uid,
        O: null,
        board: Array(9).fill(""),
        turn: "X"
      });
      showMessage(`Room ID: ${roomRef.id}`);
      const unsub = onSnapshot(roomRef, (snap) => {
        const data = snap.data();
        if (data?.O) {
          unsub();
          playGame({ id: roomRef.id, ...data });
        }
      });
    }

    async function joinFriendRoom() {
      const id = prompt("Enter Room ID:");
      if (!id) return;
      const ref = doc(db, "rooms", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return showMessage("Room not found.");
      const data = snap.data();
      if (data.O) return showMessage("Room is full.");
      await updateDoc(ref, { O: currentUser.uid });
      playGame({ id: id, ...data, O: currentUser.uid });
    }
  </script>

  <style>
    body {
      background: #111;
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
      text-align: center;
    }
    section {
      display: none;
      margin-top: 50px;
    }
    input, button {
      margin: 10px;
      padding: 10px;
      background: #222;
      border: none;
      color: #0ff;
      border: 1px solid #0ff;
    }
    button:hover {
      background: #0ff;
      color: #111;
    }
    .glow {
      text-shadow: 0 0 5px #0ff, 0 0 10px #0ff;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      gap: 10px;
      justify-content: center;
      margin: 20px;
    }
    .cell {
      width: 80px;
      height: 80px;
      font-size: 2em;
      line-height: 80px;
      border: 1px solid #0ff;
      cursor: pointer;
    }
    #message-box {
      margin-top: 20px;
      padding: 10px;
      background: #222;
      color: #0ff;
      display: none;
      border: 1px solid #0ff;
    }
  </style>
</head>
<body>
  <section id="login-section">
    <h2 class="glow">Login</h2>
    <input id="login-email" placeholder="Email">
    <input id="login-pass" type="password" placeholder="Password">
    <button id="login-btn">Login</button>
    <button id="to-signup">Go to Signup</button>
  </section>

  <section id="signup-section">
    <h2 class="glow">Signup</h2>
    <input id="signup-email" placeholder="Email">
    <input id="signup-pass" type="password" placeholder="Password">
    <button id="signup-btn">Signup</button>
    <button id="to-login">Go to Login</button>
  </section>

  <section id="dashboard">
    <h2 class="glow">Welcome, <span id="username"></span></h2>
    <div id="stats"></div>
    <input id="username-input" placeholder="New Username">
    <button id="update-username">Update Username</button>
    <button id="play-random">Play Random</button>
    <button id="play-friend">Play With Friend</button>
    <button id="logout-btn">Logout</button>
  </section>

  <section id="game-section">
    <h2 id="game-status" class="glow">Your Turn</h2>
    <div class="board">
      <div id="cell-0" class="cell" onclick="cellClick(0)"></div>
      <div id="cell-1" class="cell" onclick="cellClick(1)"></div>
      <div id="cell-2" class="cell" onclick="cellClick(2)"></div>
      <div id="cell-3" class="cell" onclick="cellClick(3)"></div>
      <div id="cell-4" class="cell" onclick="cellClick(4)"></div>
      <div id="cell-5" class="cell" onclick="cellClick(5)"></div>
      <div id="cell-6" class="cell" onclick="cellClick(6)"></div>
      <div id="cell-7" class="cell" onclick="cellClick(7)"></div>
      <div id="cell-8" class="cell" onclick="cellClick(8)"></div>
    </div>
  </section>

  <div id="message-box"></div>
</body>
</html>
