<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Realtime Tic-Tac-Toe</title>
  <style>
    body {
      background-color: #0d0d0d;
      font-family: Arial, sans-serif;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    .glow {
      color: #0ff;
      text-shadow: 0 0 5px #0ff, 0 0 10px #0ff, 0 0 20px #0ff;
      font-weight: bold;
    }
    .game-grid {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 5px;
      margin-top: 20px;
    }
    .cell {
      width: 100px;
      height: 100px;
      background: #111;
      border: 2px solid #0ff;
      font-size: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #0ff;
    }
    #turn-display, #opponent-name {
      margin: 10px;
      font-size: 1.2em;
    }
  </style>
</head>
<body>

  <h1 class="glow">Realtime Tic-Tac-Toe</h1>
  <div id="opponent-name" class="glow">Waiting...</div>
  <div id="turn-display" class="glow"></div>
  <div class="game-grid">
    <div class="cell" id="cell-0"></div>
    <div class="cell" id="cell-1"></div>
    <div class="cell" id="cell-2"></div>
    <div class="cell" id="cell-3"></div>
    <div class="cell" id="cell-4"></div>
    <div class="cell" id="cell-5"></div>
    <div class="cell" id="cell-6"></div>
    <div class="cell" id="cell-7"></div>
    <div class="cell" id="cell-8"></div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js"></script>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      deleteDoc,
      doc,
      onSnapshot,
      getDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

    // Firebase config
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDs2taPm-p2O-dYdBToYwq7vZBUSDNISyg",
  authDomain: "earn-itt.firebaseapp.com",
  projectId: "earn-itt",
  storageBucket: "earn-itt.firebasestorage.app",
  messagingSenderId: "785360520679",
  appId: "1:785360520679:web:ac2e2710ece34591a52942",
  measurementId: "G-P4Q2KYTBBM"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    async function randomMatchmaking(currentUser) {
      const queueRef = collection(db, "matchmaking");
      const roomsRef = collection(db, "rooms");

      const q = query(queueRef, where("inQueue", "==", true));
      const snapshot = await getDocs(q);

      if (!snapshot.empty) {
        const opponentDoc = snapshot.docs[0];
        const opponentData = opponentDoc.data();

        const room = await addDoc(roomsRef, {
          playerX: opponentData,
          playerO: {
            uid: currentUser.uid,
            username: "You"
          },
          board: ["", "", "", "", "", "", "", "", ""],
          currentTurn: "X",
          winner: null
        });

        await deleteDoc(doc(queueRef, opponentDoc.id));
        startGame(room.id, "O");
      } else {
        const waitingRef = await addDoc(queueRef, {
          uid: currentUser.uid,
          username: "You",
          inQueue: true
        });

        const unsub = onSnapshot(collection(db, "rooms"), (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            const data = change.doc.data();
            if (
              data.playerX?.uid === currentUser.uid &&
              data.playerO
            ) {
              unsub();
              deleteDoc(doc(queueRef, waitingRef.id));
              startGame(change.doc.id, "X");
            }
          });
        });
      }
    }

    function startGame(roomId, playerSymbol) {
      const gameRef = doc(db, "rooms", roomId);
      const gameBoard = document.querySelectorAll(".cell");
      const statusDisplay = document.getElementById("turn-display");
      const nameDisplay = document.getElementById("opponent-name");

      gameBoard.forEach((cell, index) => {
        cell.addEventListener("click", async () => {
          const snapshot = await getDoc(gameRef);
          const data = snapshot.data();
          if (data.currentTurn === playerSymbol && !data.board[index] && !data.winner) {
            data.board[index] = playerSymbol;
            data.currentTurn = playerSymbol === "X" ? "O" : "X";
            await updateDoc(gameRef, {
              board: data.board,
              currentTurn: data.currentTurn
            });
          }
        });
      });

      onSnapshot(gameRef, (snapshot) => {
        const data = snapshot.data();
        const board = data.board;
        const turn = data.currentTurn;
        const winner = data.winner;

        gameBoard.forEach((cell, i) => {
          cell.textContent = board[i];
        });

        if (winner) {
          statusDisplay.innerHTML = `<span class="glow">${winner === playerSymbol ? "You Win!" : "You Lose!"}</span>`;
        } else if (turn === playerSymbol) {
          statusDisplay.innerHTML = `<span class="glow">Your Turn</span>`;
        } else {
          statusDisplay.innerHTML = `<span class="glow">Opponent Turn</span>`;
        }

        const pX = data.playerX?.username || "Player X";
        const pO = data.playerO?.username || "Player O";
        nameDisplay.textContent = `${pX} vs ${pO}`;
      });
    }

    // Auth and start matchmaking
    onAuthStateChanged(auth, (user) => {
      if (user) {
        randomMatchmaking(user);
      } else {
        signInAnonymously(auth);
      }
    });
  </script>
</body>
</html>
