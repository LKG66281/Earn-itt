<!DOCTYPE html>
<html>
<head>
  <title>Real-Time Tic-Tac-Toe</title>
  <style>
    body {
      background: #111;
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    .container {
      max-width: 400px;
      margin: auto;
      background: #222;
      padding: 20px;
      border-radius: 10px;
    }
    input, button {
      padding: 10px;
      margin: 10px;
      width: 90%;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #28a745;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      gap: 5px;
      justify-content: center;
      margin-top: 20px;
    }
    .cell {
      width: 80px;
      height: 80px;
      background: #333;
      font-size: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      border-radius: 5px;
    }
    .hidden { display: none; }
    .message-box {
      background: #333;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      box-shadow: 0 0 10px #0f0;
      animation: glow 1s infinite alternate;
    }
    @keyframes glow {
      from { box-shadow: 0 0 10px #0f0; }
      to { box-shadow: 0 0 20px #0f0; }
    }
  </style>
</head>
<body>

<div class="container" id="login-section">
  <h2>Login</h2>
  <input id="email" type="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <input id="username" type="text" placeholder="Username (Saved)" />
  <button id="login-btn">Login</button>
</div>

<div class="container hidden" id="dashboard">
  <h2>Welcome, <span id="display-username"></span></h2>
  <button id="play-btn">Play</button>
  <button id="logout-btn">Logout</button>
</div>

<div class="container hidden" id="game">
  <h3><span id="p1"></span> vs <span id="p2"></span></h3>
  <div class="board" id="board"></div>
  <div class="message-box" id="message-box">Waiting...</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, addDoc, deleteDoc, query, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDptrY_22JlFegSAzXU52Wg8Wu6TUXqqjI",
    authDomain: "earn-it-7d72d.firebaseapp.com",
    projectId: "earn-it-7d72d",
    storageBucket: "earn-it-7d72d.appspot.com",
    messagingSenderId: "1756161084",
    appId: "1:1756161084:web:3db1e0d934ac844ed28f39"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const loginSection = document.getElementById("login-section");
  const dashboard = document.getElementById("dashboard");
  const game = document.getElementById("game");

  const email = document.getElementById("email");
  const password = document.getElementById("password");
  const usernameInput = document.getElementById("username");

  const messageBox = document.getElementById("message-box");

  let currentUser, currentRoomId, playerSymbol, isPlayerTurn;

  document.getElementById("login-btn").onclick = async () => {
    try {
      const userCred = await signInWithEmailAndPassword(auth, email.value, password.value);
      await setDoc(doc(db, "users", userCred.user.uid), {
        username: usernameInput.value,
        wins: 0,
        losses: 0,
        ties: 0,
        gamesPlayed: 0
      }, { merge: true });
    } catch (e) {
      alert("Login Failed");
    }
  };

  document.getElementById("logout-btn").onclick = () => signOut(auth);

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      loginSection.classList.add("hidden");
      dashboard.classList.remove("hidden");

      const userData = await getDoc(doc(db, "users", user.uid));
      document.getElementById("display-username").innerText = userData.data()?.username || "Player";
    }
  });

  document.getElementById("play-btn").onclick = async () => {
    const waitingRef = collection(db, "waiting");
    const q = query(waitingRef, where("uid", "!=", currentUser.uid));
    const waitingSnap = await getDocs(q);

    if (!waitingSnap.empty) {
      const opponentDoc = waitingSnap.docs[0];
      const opponent = opponentDoc.data();
      await deleteDoc(opponentDoc.ref);

      const roomRef = doc(collection(db, "rooms"));
      await setDoc(roomRef, {
        playerX: { uid: opponent.uid, username: opponent.username },
        playerO: { uid: currentUser.uid, username: usernameInput.value },
        board: Array(9).fill(""),
        turn: "X",
        winner: ""
      });
      startGame(roomRef.id, "O");
    } else {
      await addDoc(waitingRef, {
        uid: currentUser.uid,
        username: usernameInput.value
      });
      messageBox.innerText = "Waiting for opponent...";
      const unsubscribe = onSnapshot(waitingRef, async (snap) => {
        const q = query(collection(db, "rooms"));
        const allRooms = await getDocs(q);
        allRooms.forEach(room => {
          const data = room.data();
          if (data.playerX?.uid === currentUser.uid || data.playerO?.uid === currentUser.uid) {
            unsubscribe();
            startGame(room.id, "X");
          }
        });
      });
    }
  };

  async function updateStats(result) {
    const ref = doc(db, "users", currentUser.uid);
    const data = { gamesPlayed: increment(1) };
    if (result === "win") data.wins = increment(1);
    if (result === "loss") data.losses = increment(1);
    if (result === "tie") data.ties = increment(1);
    await updateDoc(ref, data);
  }

  function startGame(roomId, symbol) {
    currentRoomId = roomId;
    playerSymbol = symbol;
    isPlayerTurn = symbol === "X";

    dashboard.classList.add("hidden");
    game.classList.remove("hidden");

    const boardEl = document.getElementById("board");
    const p1 = document.getElementById("p1");
    const p2 = document.getElementById("p2");

    const roomRef = doc(db, "rooms", roomId);
    onSnapshot(roomRef, async (snap) => {
      const data = snap.data();
      boardEl.innerHTML = "";
      data.board.forEach((cell, i) => {
        const div = document.createElement("div");
        div.className = "cell";
        div.innerText = cell;
        if (cell === "" && data.turn === playerSymbol && !data.winner) {
          div.onclick = async () => {
            const updatedBoard = [...data.board];
            updatedBoard[i] = playerSymbol;
            const winner = checkWinner(updatedBoard);
            const update = {
              board: updatedBoard,
              turn: playerSymbol === "X" ? "O" : "X"
            };
            if (winner) update.winner = winner;
            await updateDoc(roomRef, update);
          };
        }
        boardEl.appendChild(div);
      });

      p1.innerText = data.playerX.username;
      p2.innerText = data.playerO.username;

      if (data.winner) {
        if (data.winner === "tie") {
          messageBox.innerText = "It's a tie!";
          updateStats("tie");
        } else if (data.winner === playerSymbol) {
          messageBox.innerText = "ðŸŽ‰ You Win!";
          updateStats("win");
        } else {
          messageBox.innerText = "ðŸ˜¢ You Lose!";
          updateStats("loss");
        }
        setTimeout(() => {
          location.reload();
        }, 4000);
      } else {
        messageBox.innerText = data.turn === playerSymbol ? "Your Turn" : "Opponent's Turn";
      }
    });
  }

  function checkWinner(b) {
    const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    for (let [a,b1,c] of wins) {
      if (b[a] && b[a] === b[b1] && b[a] === b[c]) return b[a];
    }
    return b.includes("") ? null : "tie";
  }
</script>
</body>
</html>
